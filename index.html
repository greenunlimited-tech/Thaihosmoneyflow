<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Financial Flow - Sankey Diagram</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plotly.js for Sankey Diagram -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- html2canvas for capturing full container -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f4f8; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dark-panel {
            background: #111827; /* Gray 900 */
            border-radius: 12px;
            border: 1px solid #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        input:focus, select:focus { outline: none; ring: 2px; ring-color: #3b82f6; }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ไอคอน
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Type: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
            Percent: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>,
            Dollar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        };

        const INCOME_CATEGORIES = [
            'สปสช.',
            'ข้าราชการ',
            'ประกันสังคม',
            'อื่นๆ'
        ];

        const EXPENSE_CATEGORIES = [
            'Labour cost ค่าแรง',
            'Material cost',
            'Capital cost',
            'อื่นๆ'
        ];

        const FONT_SIZES = [10, 12, 14, 16, 18, 20, 24, 28, 32];

        const App = () => {
            const [globalFontSize, setGlobalFontSize] = useState(16);
            const [displayMode, setDisplayMode] = useState('amount');

            const [incomes, setIncomes] = useState([
                { id: 1, name: 'เหมาจ่ายรายหัว (Capitation)', amount: 6000000, category: 'สปสช.', fontSize: 14 },
                { id: 2, name: 'เบิกจ่ายตรงกรมบัญชีกลาง', amount: 3500000, category: 'ข้าราชการ', fontSize: 14 },
                { id: 3, name: 'ค่ารักษาพยาบาล (ประกันสังคม)', amount: 2500000, category: 'ประกันสังคม', fontSize: 14 },
                { id: 4, name: 'เงินบริจาค', amount: 500000, category: 'อื่นๆ', fontSize: 14 },
                { id: 5, name: 'ชำระเงินเอง (Cash)', amount: 1200000, category: 'อื่นๆ', fontSize: 14 }
            ]);

            const [expenses, setExpenses] = useState([
                { id: 1, name: 'เงินเดือนแพทย์และพยาบาล', amount: 7000000, category: 'Labour cost ค่าแรง', fontSize: 14 },
                { id: 2, name: 'ค่าจ้างลูกจ้างชั่วคราว', amount: 1500000, category: 'Labour cost ค่าแรง', fontSize: 14 },
                { id: 3, name: 'ค่ายาและเวชภัณฑ์', amount: 3000000, category: 'Material cost', fontSize: 14 },
                { id: 4, name: 'ค่าสาธารณูปโภค', amount: 800000, category: 'Material cost', fontSize: 14 },
                { id: 5, name: 'ค่าเสื่อมราคา', amount: 1500000, category: 'Capital cost', fontSize: 14 },
                { id: 6, name: 'ค่าตามจ่ายโรงพยาบาล', amount: 500000, category: 'อื่นๆ', fontSize: 14 },
            ]);

            const chartRef = useRef(null);
            const captureRef = useRef(null); // Ref สำหรับจับภาพทั้งกราฟและ Footer

            const handleIncomeChange = (id, field, value) => {
                setIncomes(incomes.map(item => item.id === id ? { ...item, [field]: value } : item));
            };

            const handleExpenseChange = (id, field, value) => {
                setExpenses(expenses.map(item => item.id === id ? { ...item, [field]: value } : item));
            };

            const addIncome = () => {
                setIncomes([...incomes, { id: Date.now(), name: 'รายรับใหม่', amount: 0, category: 'อื่นๆ', fontSize: 14 }]);
            };

            const addExpense = () => {
                setExpenses([...expenses, { id: Date.now(), name: 'รายจ่ายใหม่', amount: 0, category: 'อื่นๆ', fontSize: 14 }]);
            };

            const removeIncome = (id) => {
                setIncomes(incomes.filter(item => item.id !== id));
            };

            const removeExpense = (id) => {
                setExpenses(expenses.filter(item => item.id !== id));
            };

            // ฟังก์ชันบันทึกรูปภาพโดยใช้ html2canvas จับภาพ container ที่กำหนด
            const handleSaveImage = async () => {
                if (!captureRef.current) return;
                
                try {
                    const canvas = await html2canvas(captureRef.current, {
                        scale: 2, 
                        backgroundColor: '#111827', 
                        logging: false,
                        useCORS: true
                    });

                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = 'hospital_financial_flow_full.png';
                    link.click();
                } catch (err) {
                    console.error("Error saving image:", err);
                    alert("ไม่สามารถบันทึกรูปภาพได้");
                }
            };

            // ฟังก์ชันบันทึก CSV
            const handleSaveCSV = () => {
                // Header
                const headers = ["Type (ประเภท)", "Name (รายการ)", "Category (หมวดหมู่)", "Amount (จำนวนเงิน)"];
                
                // Rows
                const incomeRows = incomes.map(item => 
                    `"Income (รายรับ)","${item.name}","${item.category}",${item.amount}`
                );
                
                const expenseRows = expenses.map(item => 
                    `"Expense (รายจ่าย)","${item.name}","${item.category}",${item.amount}`
                );

                // Combine CSV Content
                const csvContent = [
                    headers.join(","),
                    ...incomeRows,
                    ...expenseRows
                ].join("\n");

                // Create Blob with BOM for Excel UTF-8 support
                const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' }); 
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "hospital_financial_data.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            const formatCurrency = (num) => {
                return num.toLocaleString('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 });
            };
            
            const formatPercent = (num) => {
                return num.toFixed(1) + '%';
            };

            const totalIncome = incomes.reduce((sum, item) => sum + Number(item.amount), 0);
            const totalExpense = expenses.reduce((sum, item) => sum + Number(item.amount), 0);
            const balance = totalIncome - totalExpense;
            const totalBudget = Math.max(totalIncome, totalExpense);

            useEffect(() => {
                if (!chartRef.current) return;

                const getLabelText = (amount, baseTotal) => {
                    if (displayMode === 'amount') {
                        return formatCurrency(amount);
                    } else {
                        if (baseTotal === 0) return '0.0%';
                        const percent = (amount / baseTotal) * 100;
                        return formatPercent(percent);
                    }
                };

                const incomeCatSums = {};
                INCOME_CATEGORIES.forEach(cat => {
                    incomeCatSums[cat] = incomes.filter(i => i.category === cat).reduce((sum, i) => sum + Number(i.amount), 0);
                });

                const expenseCatSums = {};
                EXPENSE_CATEGORIES.forEach(cat => {
                    expenseCatSums[cat] = expenses.filter(e => e.category === cat).reduce((sum, e) => sum + Number(e.amount), 0);
                });

                const incomeLabels = incomes.map(i => {
                    const catTotal = incomeCatSums[i.category] || 0;
                    return `${i.name}<br><span style="font-size:0.75em; opacity:0.8">${getLabelText(i.amount, catTotal)}</span>`;
                });
                
                const incomeCatLabels = INCOME_CATEGORIES.map(cat => {
                    const sum = incomeCatSums[cat];
                    return `${cat}<br><span style="font-size:0.75em; opacity:0.8">${getLabelText(sum, totalIncome)}</span>`;
                });

                const deficitLabel = `ขาดดุล (Deficit)<br><span style="font-size:0.75em; opacity:0.8">${getLabelText(Math.abs(balance), totalBudget)}</span>`;
                
                const totalLabel = ""; 
                
                const expenseCatLabels = EXPENSE_CATEGORIES.map(cat => {
                    const sum = expenseCatSums[cat];
                    return `${cat}<br><span style="font-size:0.75em; opacity:0.8">${getLabelText(sum, totalExpense)}</span>`;
                });

                const surplusLabel = `เงินคงเหลือ (Surplus)<br><span style="font-size:0.75em; opacity:0.8">${getLabelText(balance, totalIncome)}</span>`;
                
                const expenseLabels = expenses.map(e => {
                    const catTotal = expenseCatSums[e.category] || 0;
                    return `${e.name}<br><span style="font-size:0.75em; opacity:0.8">${getLabelText(e.amount, catTotal)}</span>`;
                });
                
                let labels = [
                    ...incomeLabels,
                    ...incomeCatLabels,
                ];
                
                if (balance < 0) labels.push(deficitLabel);

                labels.push(totalLabel);
                labels.push(...expenseCatLabels);

                if (balance > 0) labels.push(surplusLabel);
                
                labels.push(...expenseLabels);

                const incomeFontSizes = incomes.map(i => i.fontSize || 14);
                const structureFontSize = globalFontSize; 
                const totalNodeFontSize = globalFontSize + 4; 
                
                const incomeCatFontSizes = Array(INCOME_CATEGORIES.length).fill(structureFontSize);
                const expenseCatFontSizes = Array(EXPENSE_CATEGORIES.length).fill(structureFontSize);
                const expenseFontSizes = expenses.map(e => e.fontSize || 14);

                let fontSizes = [
                    ...incomeFontSizes,
                    ...incomeCatFontSizes
                ];

                if (balance < 0) fontSizes.push(structureFontSize); 

                fontSizes.push(totalNodeFontSize); 
                fontSizes.push(...expenseCatFontSizes); 

                if (balance > 0) fontSizes.push(structureFontSize); 
                
                fontSizes.push(...expenseFontSizes); 

                let idx = 0;
                const incomeItemStart = idx; idx += incomeLabels.length;
                const incomeCatStart = idx; idx += incomeCatLabels.length;
                
                const deficitNode = balance < 0 ? idx++ : -1;
                const totalNode = idx++;
                
                const expenseCatStart = idx; idx += expenseCatLabels.length;
                const surplusNode = balance > 0 ? idx++ : -1;
                
                const expenseItemStart = idx;

                const source = [];
                const target = [];
                const value = [];
                const color = [];

                incomes.forEach((inc, i) => {
                    if (Number(inc.amount) > 0) {
                        const catIndex = INCOME_CATEGORIES.indexOf(inc.category);
                        if (catIndex !== -1) {
                            source.push(incomeItemStart + i);
                            target.push(incomeCatStart + catIndex);
                            value.push(Number(inc.amount));
                            color.push('rgba(16, 185, 129, 0.3)'); 
                        }
                    }
                });

                INCOME_CATEGORIES.forEach((catName, i) => {
                    const sumCat = incomes
                        .filter(item => item.category === catName)
                        .reduce((sum, item) => sum + Number(item.amount), 0);
                    
                    if (sumCat > 0) {
                        source.push(incomeCatStart + i);
                        target.push(totalNode);
                        value.push(sumCat);
                        color.push('rgba(5, 150, 105, 0.4)'); 
                    }
                });

                if (balance < 0) {
                    source.push(deficitNode);
                    target.push(totalNode);
                    value.push(Math.abs(balance));
                    color.push('rgba(239, 68, 68, 0.3)'); 
                }

                EXPENSE_CATEGORIES.forEach((catName, i) => {
                    const sumCat = expenses
                        .filter(item => item.category === catName)
                        .reduce((sum, item) => sum + Number(item.amount), 0);
                    
                    if (sumCat > 0) {
                        source.push(totalNode);
                        target.push(expenseCatStart + i);
                        value.push(sumCat);
                        color.push('rgba(220, 38, 38, 0.4)'); 
                    }
                });

                if (balance > 0) {
                    source.push(totalNode);
                    target.push(surplusNode);
                    value.push(balance);
                    color.push('rgba(52, 211, 153, 0.6)'); 
                }

                expenses.forEach((exp, i) => {
                    if (Number(exp.amount) > 0) {
                        const catIndex = EXPENSE_CATEGORIES.indexOf(exp.category);
                        if (catIndex !== -1) {
                            source.push(expenseCatStart + catIndex);
                            target.push(expenseItemStart + i);
                            value.push(Number(exp.amount));
                            color.push('rgba(239, 68, 68, 0.3)'); 
                        }
                    }
                });

                const nodeColors = labels.map((label, i) => {
                    if (i < incomeCatStart) return '#6ee7b7'; 
                    if (i >= incomeCatStart && i < (balance < 0 ? deficitNode : totalNode)) return '#10b981';
                    if (i === deficitNode) return '#ef4444'; 
                    if (i === totalNode) return '#3b82f6'; 
                    if (i >= expenseCatStart && i < (balance > 0 ? surplusNode : expenseItemStart)) return '#f87171';
                    if (i === surplusNode) return '#34d399';
                    if (i >= expenseItemStart) return '#fca5a5';
                    return '#9ca3af';
                });

                const data = {
                    type: "sankey",
                    orientation: "h",
                    node: {
                        pad: 20,
                        thickness: 25,
                        line: { color: "#374151", width: 0.5 },
                        label: labels,
                        color: nodeColors,
                        hovertemplate: '%{label}<extra></extra>', 
                        textfont: {
                            family: 'Sarabun',
                            size: fontSizes, 
                            color: '#ffffff'
                        }
                    },
                    link: {
                        source: source,
                        target: target,
                        value: value,
                        color: color,
                        hovertemplate: '%{source.label} → %{target.label}<br>จำนวน: %{value:,.0f} บาท<extra></extra>'
                    }
                };

                const layout = {
                    title: {
                        text: "แผนภาพกระแสการเงินโรงพยาบาล (Hospital Financial Flow)",
                        font: { size: globalFontSize + 8, family: 'Sarabun', color: '#ffffff' }, 
                        pad: { b: 20 }
                    },
                    font: { size: globalFontSize, family: 'Sarabun', color: '#ffffff' }, 
                    paper_bgcolor: '#111827', 
                    plot_bgcolor: '#111827',
                    height: 700,
                    margin: { l: 150, r: 150, t: 120, b: 120 },
                    dragmode: false,
                };

                const config = {
                    responsive: true,
                    displayModeBar: false, 
                };

                Plotly.newPlot(chartRef.current, [data], layout, config);

            }, [incomes, expenses, balance, globalFontSize, displayMode]); 

            const getIncomeCategoryColor = (cat) => {
                switch(cat) {
                    case 'สปสช.': return 'bg-blue-100 text-blue-800 border-blue-200';
                    case 'ข้าราชการ': return 'bg-amber-100 text-amber-800 border-amber-200';
                    case 'ประกันสังคม': return 'bg-purple-100 text-purple-800 border-purple-200';
                    default: return 'bg-gray-100 text-gray-800 border-gray-200';
                }
            };

            const getExpenseCategoryColor = (cat) => {
                switch(cat) {
                    case 'Labour cost ค่าแรง': return 'bg-rose-100 text-rose-800 border-rose-200';
                    case 'Material cost': return 'bg-orange-100 text-orange-800 border-orange-200';
                    case 'Capital cost': return 'bg-indigo-100 text-indigo-800 border-indigo-200';
                    default: return 'bg-gray-100 text-gray-800 border-gray-200';
                }
            };

            const FontSizeSelector = ({ value, onChange }) => (
                <div className="flex items-center" title="ขนาดตัวอักษร">
                    <span className="text-gray-400 text-xs mr-1">A</span>
                    <select 
                        value={value} 
                        onChange={(e) => onChange(Number(e.target.value))}
                        className="p-1 rounded text-xs border border-gray-200 bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none w-12"
                    >
                        {FONT_SIZES.map(size => (
                            <option key={size} value={size}>{size}</option>
                        ))}
                    </select>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col gap-6 max-w-7xl mx-auto">
                    
                    {/* Header */}
                    <div className="flex items-center justify-between glass-panel p-6">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-3 rounded-lg text-white">
                                <Icons.TrendingUp />
                            </div>
                            <div>
                                <h1 className="text-xl md:text-2xl font-bold text-gray-800">ระบบวิเคราะห์การเงินโรงพยาบาล</h1>
                                <p className="text-gray-500 text-sm">Flow: รายรับ (4 โหมด) → งบรวม → รายจ่าย (4 โหมด)</p>
                            </div>
                        </div>
                        <div className="text-right hidden md:block">
                            <div className="text-sm text-gray-500">สถานะการเงินรวม</div>
                            <div className={`text-xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {balance >= 0 ? 'กำไร (Surplus)' : 'ขาดทุน (Deficit)'} {formatCurrency(Math.abs(balance))}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        
                        {/* Input Section (Left) */}
                        <div className="xl:col-span-1 flex flex-col gap-6 h-full">
                            
                            {/* Incomes */}
                            <div className="glass-panel p-4 flex-1 flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <h2 className="text-lg font-semibold text-emerald-700">รายรับ (Incomes)</h2>
                                        <div className="text-xs text-gray-500">จำแนกตาม 4 กองทุนหลัก</div>
                                    </div>
                                    <button onClick={addIncome} className="text-emerald-600 bg-emerald-50 hover:bg-emerald-100 p-2 rounded transition">
                                        <Icons.Plus /> เพิ่มรายการ
                                    </button>
                                </div>
                                <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1 max-h-[350px]">
                                    {incomes.map((item) => (
                                        <div key={item.id} className="bg-white p-3 rounded border border-gray-100 shadow-sm animate-fadeIn">
                                            <div className="flex gap-2 mb-2">
                                                <input 
                                                    type="text" 
                                                    value={item.name}
                                                    onChange={(e) => handleIncomeChange(item.id, 'name', e.target.value)}
                                                    className="flex-1 p-2 border border-gray-200 rounded text-sm focus:border-emerald-500"
                                                    placeholder="ชื่อรายการรายรับ"
                                                />
                                                <button onClick={() => removeIncome(item.id)} className="text-gray-400 hover:text-red-500 px-1">
                                                    <Icons.Trash />
                                                </button>
                                            </div>
                                            <div className="flex gap-2 items-center">
                                                <select 
                                                    value={item.category}
                                                    onChange={(e) => handleIncomeChange(item.id, 'category', e.target.value)}
                                                    className={`p-2 rounded text-xs border ${getIncomeCategoryColor(item.category)} font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none cursor-pointer appearance-none w-28`}
                                                >
                                                    {INCOME_CATEGORIES.map(cat => (
                                                        <option key={cat} value={cat}>{cat}</option>
                                                    ))}
                                                </select>

                                                <FontSizeSelector 
                                                    value={item.fontSize || 14} 
                                                    onChange={(val) => handleIncomeChange(item.id, 'fontSize', val)} 
                                                />

                                                <div className="relative flex-1">
                                                    <span className="absolute left-2 top-2 text-gray-400 text-sm">฿</span>
                                                    <input 
                                                        type="number" 
                                                        value={item.amount}
                                                        onChange={(e) => handleIncomeChange(item.id, 'amount', Number(e.target.value))}
                                                        className="w-full p-2 pl-6 border border-gray-200 rounded text-sm text-right focus:border-emerald-500 font-mono"
                                                        placeholder="จำนวนเงิน"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-3 border-t flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <span className="text-sm font-medium text-gray-600">รวมรายรับ</span>
                                    <span className="text-lg font-bold text-emerald-600">{formatCurrency(totalIncome)}</span>
                                </div>
                            </div>

                            {/* Expenses */}
                            <div className="glass-panel p-4 flex-1 flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <h2 className="text-lg font-semibold text-red-700">รายจ่าย (Expenses)</h2>
                                        <div className="text-xs text-gray-500">จำแนกตาม 4 หมวดรายจ่าย</div>
                                    </div>
                                    <button onClick={addExpense} className="text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition">
                                        <Icons.Plus /> เพิ่มรายการ
                                    </button>
                                </div>
                                <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1 max-h-[350px]">
                                    {expenses.map((item) => (
                                        <div key={item.id} className="bg-white p-3 rounded border border-gray-100 shadow-sm animate-fadeIn">
                                            <div className="flex gap-2 mb-2">
                                                <input 
                                                    type="text" 
                                                    value={item.name}
                                                    onChange={(e) => handleExpenseChange(item.id, 'name', e.target.value)}
                                                    className="flex-1 p-2 border border-gray-200 rounded text-sm focus:border-red-500"
                                                    placeholder="ชื่อค่าใช้จ่าย"
                                                />
                                                <button onClick={() => removeExpense(item.id)} className="text-gray-400 hover:text-red-500 px-1">
                                                    <Icons.Trash />
                                                </button>
                                            </div>
                                            <div className="flex gap-2 items-center">
                                                <select 
                                                    value={item.category}
                                                    onChange={(e) => handleExpenseChange(item.id, 'category', e.target.value)}
                                                    className={`p-2 rounded text-xs border ${getExpenseCategoryColor(item.category)} font-medium focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none cursor-pointer appearance-none w-32`}
                                                >
                                                    {EXPENSE_CATEGORIES.map(cat => (
                                                        <option key={cat} value={cat}>{cat}</option>
                                                    ))}
                                                </select>

                                                <FontSizeSelector 
                                                    value={item.fontSize || 14} 
                                                    onChange={(val) => handleExpenseChange(item.id, 'fontSize', val)} 
                                                />

                                                <div className="relative flex-1">
                                                    <span className="absolute left-2 top-2 text-gray-400 text-sm">฿</span>
                                                    <input 
                                                        type="number" 
                                                        value={item.amount}
                                                        onChange={(e) => handleExpenseChange(item.id, 'amount', Number(e.target.value))}
                                                        className="w-full p-2 pl-6 border border-gray-200 rounded text-sm text-right focus:border-red-500 font-mono"
                                                        placeholder="จำนวน"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-3 border-t flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <span className="text-sm font-medium text-gray-600">รวมรายจ่าย</span>
                                    <span className="text-lg font-bold text-red-600">{formatCurrency(totalExpense)}</span>
                                </div>
                            </div>

                        </div>

                        {/* Chart Section (Dark Mode for White Text) */}
                        <div className="xl:col-span-2 dark-panel flex flex-col min-h-[700px] overflow-hidden">
                           
                           {/* Toolbar Control (Outside Capture) */}
                           <div className="p-4 border-b border-gray-700 bg-gray-800 flex flex-col lg:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-4 flex-wrap">
                                    {/* Font Size Control */}
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm text-gray-300 font-medium flex items-center gap-2">
                                            <Icons.Type /> ขนาดอักษร:
                                        </span>
                                        <div className="flex bg-gray-700 rounded-lg p-1">
                                            <button 
                                                onClick={() => setGlobalFontSize(14)}
                                                className={`px-3 py-1 text-sm rounded-md transition ${globalFontSize === 14 ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:text-white'}`}
                                            >
                                                เล็ก
                                            </button>
                                            <button 
                                                onClick={() => setGlobalFontSize(18)}
                                                className={`px-3 py-1 text-sm rounded-md transition ${globalFontSize === 18 ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:text-white'}`}
                                            >
                                                กลาง
                                            </button>
                                            <button 
                                                onClick={() => setGlobalFontSize(24)}
                                                className={`px-3 py-1 text-sm rounded-md transition ${globalFontSize === 24 ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:text-white'}`}
                                            >
                                                ใหญ่
                                            </button>
                                        </div>
                                    </div>

                                    {/* Display Mode Control */}
                                    <div className="flex items-center gap-2">
                                         <div className="flex bg-gray-700 rounded-lg p-1">
                                            <button 
                                                onClick={() => setDisplayMode('amount')}
                                                className={`flex items-center gap-1 px-3 py-1 text-sm rounded-md transition ${displayMode === 'amount' ? 'bg-emerald-600 text-white shadow' : 'text-gray-300 hover:text-white'}`}
                                            >
                                                <Icons.Dollar /> แสดงจำนวนเงิน
                                            </button>
                                            <button 
                                                onClick={() => setDisplayMode('percent')}
                                                className={`flex items-center gap-1 px-3 py-1 text-sm rounded-md transition ${displayMode === 'percent' ? 'bg-emerald-600 text-white shadow' : 'text-gray-300 hover:text-white'}`}
                                            >
                                                <Icons.Percent /> แสดงเปอร์เซ็นต์
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleSaveCSV}
                                        className="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium shadow-lg hover:shadow-white/10 transition transform hover:-translate-y-0.5"
                                        title="บันทึกเป็น CSV"
                                    >
                                        <Icons.FileText /> บันทึก CSV
                                    </button>
                                    <button 
                                        onClick={handleSaveImage}
                                        className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium shadow-lg hover:shadow-blue-500/30 transition transform hover:-translate-y-0.5"
                                        title="บันทึกรูปภาพ"
                                    >
                                        <Icons.Download /> บันทึกรูปภาพ
                                    </button>
                                </div>
                           </div>

                           {/* Capture Container (Chart + Footer) */}
                           <div ref={captureRef} className="flex flex-col flex-1 bg-gray-900">
                               <div className="flex-1 w-full relative bg-gray-900" ref={chartRef}>
                                    {/* Plotly Chart renders here */}
                               </div>
                               
                               {/* Footer ด้านล่าง Chart (เพิ่มสรุปยอดรวมที่นี่แทน) */}
                               <div className="p-6 bg-gray-800 border-t border-gray-700 flex flex-col items-center">
                                    <h3 className="text-gray-400 text-sm mb-1 uppercase tracking-wider">งบประมาณรวม (Total Budget)</h3>
                                    <p className="text-3xl font-bold text-blue-400 font-mono tracking-tight">
                                        {formatCurrency(totalBudget)}
                                    </p>
                                    <div className="flex gap-6 mt-4 text-xs text-gray-500 flex-wrap justify-center">
                                         <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-emerald-500"></span> รายรับ (Incomes)</span>
                                         <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-blue-600"></span> งบรวม (Total Budget)</span>
                                         <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-red-500"></span> รายจ่าย (Expenses)</span>
                                    </div>
                                    {balance < 0 && <span className="mt-2 text-red-400 font-bold text-sm bg-red-900/20 px-3 py-1 rounded-full border border-red-800">⚠️ สถานะขาดดุล (Deficit)</span>}
                               </div>
                           </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
