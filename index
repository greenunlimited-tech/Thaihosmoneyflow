<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Financial Flow - Sankey Diagram</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plotly.js for Sankey Diagram -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f4f8; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dark-panel {
            background: #111827; /* Gray 900 */
            border-radius: 12px;
            border: 1px solid #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        input:focus, select:focus { outline: none; ring: 2px; ring-color: #3b82f6; }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
        };

        const INCOME_CATEGORIES = [
            '‡∏™‡∏õ‡∏™‡∏ä.',
            '‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£',
            '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°',
            '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
        ];

        const EXPENSE_CATEGORIES = [
            'Labour cost ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á',
            'Material cost',
            'Capital cost',
            '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
        ];

        const App = () => {
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const [incomes, setIncomes] = useState([
                { id: 1, name: '‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏´‡∏±‡∏ß (Capitation)', amount: 6000000, category: '‡∏™‡∏õ‡∏™‡∏ä.' },
                { id: 2, name: '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏•‡∏≤‡∏á', amount: 3500000, category: '‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£' },
                { id: 3, name: '‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)', amount: 2500000, category: '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°' },
                { id: 4, name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ', amount: 500000, category: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' },
                { id: 5, name: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏≠‡∏á (Cash)', amount: 1200000, category: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }
            ]);

            const [expenses, setExpenses] = useState([
                { id: 1, name: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', amount: 7000000, category: 'Labour cost ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á' },
                { id: 2, name: '‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß', amount: 1500000, category: 'Labour cost ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á' },
                { id: 3, name: '‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå', amount: 3000000, category: 'Material cost' },
                { id: 4, name: '‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ', amount: 800000, category: 'Material cost' },
                { id: 5, name: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤', amount: 1500000, category: 'Capital cost' },
                { id: 6, name: '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', amount: 500000, category: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' },
            ]);

            const chartRef = useRef(null);

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const handleIncomeChange = (id, field, value) => {
                setIncomes(incomes.map(item => item.id === id ? { ...item, [field]: value } : item));
            };

            const handleExpenseChange = (id, field, value) => {
                setExpenses(expenses.map(item => item.id === id ? { ...item, [field]: value } : item));
            };

            const addIncome = () => {
                setIncomes([...incomes, { id: Date.now(), name: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà', amount: 0, category: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }]);
            };

            const addExpense = () => {
                setExpenses([...expenses, { id: Date.now(), name: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà', amount: 0, category: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }]);
            };

            const removeIncome = (id) => {
                setIncomes(incomes.filter(item => item.id !== id));
            };

            const removeExpense = (id) => {
                setExpenses(expenses.filter(item => item.id !== id));
            };

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
            const totalIncome = incomes.reduce((sum, item) => sum + Number(item.amount), 0);
            const totalExpense = expenses.reduce((sum, item) => sum + Number(item.amount), 0);
            const balance = totalIncome - totalExpense;

            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Sankey
            useEffect(() => {
                if (!chartRef.current) return;

                // 1. Prepare Nodes Labels
                const incomeLabels = incomes.map(i => i.name);
                const incomeCatLabels = INCOME_CATEGORIES;
                const deficitLabel = "‡∏Ç‡∏≤‡∏î‡∏î‡∏∏‡∏• (Deficit)";
                const totalLabel = "‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏° (Total Budget)";
                const expenseCatLabels = EXPENSE_CATEGORIES;
                const surplusLabel = "‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Surplus)";
                const expenseLabels = expenses.map(e => e.name);
                
                let labels = [
                    ...incomeLabels,
                    ...incomeCatLabels,
                ];
                
                if (balance < 0) labels.push(deficitLabel);

                labels.push(totalLabel);
                labels.push(...expenseCatLabels);

                if (balance > 0) labels.push(surplusLabel);
                
                labels.push(...expenseLabels);

                // 2. Define Indices map
                let idx = 0;
                const incomeItemStart = idx; idx += incomeLabels.length;
                const incomeCatStart = idx; idx += incomeCatLabels.length;
                
                const deficitNode = balance < 0 ? idx++ : -1;
                const totalNode = idx++;
                
                const expenseCatStart = idx; idx += expenseCatLabels.length;
                const surplusNode = balance > 0 ? idx++ : -1;
                
                const expenseItemStart = idx;

                // 3. Create Links
                const source = [];
                const target = [];
                const value = [];
                const color = [];

                // Step 3.1: Income Items -> Income Categories
                incomes.forEach((inc, i) => {
                    if (Number(inc.amount) > 0) {
                        const catIndex = INCOME_CATEGORIES.indexOf(inc.category);
                        if (catIndex !== -1) {
                            source.push(incomeItemStart + i);
                            target.push(incomeCatStart + catIndex);
                            value.push(Number(inc.amount));
                            color.push('rgba(16, 185, 129, 0.3)'); 
                        }
                    }
                });

                // Step 3.2: Income Categories -> Total Budget
                INCOME_CATEGORIES.forEach((catName, i) => {
                    const sumCat = incomes
                        .filter(item => item.category === catName)
                        .reduce((sum, item) => sum + Number(item.amount), 0);
                    
                    if (sumCat > 0) {
                        source.push(incomeCatStart + i);
                        target.push(totalNode);
                        value.push(sumCat);
                        color.push('rgba(5, 150, 105, 0.4)'); 
                    }
                });

                // Step 3.3: Deficit -> Total Budget
                if (balance < 0) {
                    source.push(deficitNode);
                    target.push(totalNode);
                    value.push(Math.abs(balance));
                    color.push('rgba(239, 68, 68, 0.3)'); 
                }

                // Step 3.4: Total Budget -> Expense Categories
                EXPENSE_CATEGORIES.forEach((catName, i) => {
                    const sumCat = expenses
                        .filter(item => item.category === catName)
                        .reduce((sum, item) => sum + Number(item.amount), 0);
                    
                    if (sumCat > 0) {
                        source.push(totalNode);
                        target.push(expenseCatStart + i);
                        value.push(sumCat);
                        color.push('rgba(220, 38, 38, 0.4)'); 
                    }
                });

                // Step 3.5: Total Budget -> Surplus
                if (balance > 0) {
                    source.push(totalNode);
                    target.push(surplusNode);
                    value.push(balance);
                    color.push('rgba(52, 211, 153, 0.6)'); 
                }

                // Step 3.6: Expense Categories -> Expense Items
                expenses.forEach((exp, i) => {
                    if (Number(exp.amount) > 0) {
                        const catIndex = EXPENSE_CATEGORIES.indexOf(exp.category);
                        if (catIndex !== -1) {
                            source.push(expenseCatStart + catIndex);
                            target.push(expenseItemStart + i);
                            value.push(Number(exp.amount));
                            color.push('rgba(239, 68, 68, 0.3)'); 
                        }
                    }
                });

                const nodeColors = labels.map((label, i) => {
                    if (i < incomeCatStart) return '#6ee7b7'; 
                    if (i >= incomeCatStart && i < (balance < 0 ? deficitNode : totalNode)) return '#10b981';
                    if (i === deficitNode) return '#ef4444'; 
                    if (i === totalNode) return '#3b82f6'; // Bright blue for total
                    if (i >= expenseCatStart && i < (balance > 0 ? surplusNode : expenseItemStart)) return '#f87171';
                    if (i === surplusNode) return '#34d399';
                    if (i >= expenseItemStart) return '#fca5a5';
                    return '#9ca3af';
                });

                const data = {
                    type: "sankey",
                    orientation: "h",
                    node: {
                        pad: 20,
                        thickness: 25,
                        line: { color: "#374151", width: 0.5 },
                        label: labels,
                        color: nodeColors,
                        hovertemplate: '%{label}<br>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: %{value:,.0f} ‡∏ö‡∏≤‡∏ó<extra></extra>',
                        // Font inside nodes not fully supported by all sankey versions, usually global font applies
                    },
                    link: {
                        source: source,
                        target: target,
                        value: value,
                        color: color,
                        hovertemplate: '%{source.label} ‚Üí %{target.label}<br>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: %{value:,.0f} ‡∏ö‡∏≤‡∏ó<extra></extra>'
                    }
                };

                // Dark Theme Layout
                const layout = {
                    title: {
                        text: "‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (Hospital Financial Flow)",
                        font: { size: 26, family: 'Sarabun', color: '#ffffff' }, // White Title, Bigger
                        pad: { b: 20 }
                    },
                    font: { size: 18, family: 'Sarabun', color: '#ffffff' }, // White Text, Bigger (18px)
                    paper_bgcolor: '#111827', // Gray 900 Background
                    plot_bgcolor: '#111827',
                    height: 700,
                    margin: { l: 20, r: 20, t: 80, b: 20 }
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'hospital_sankey_dark_large_font',
                        height: 1080, // Full HD Height
                        width: 1920,  // Full HD Width
                        scale: 1.5    // Scale up for sharpness
                    }
                };

                Plotly.newPlot(chartRef.current, [data], layout, config);

            }, [incomes, expenses, balance]);

            const formatCurrency = (num) => {
                return num.toLocaleString('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 });
            };

            const getIncomeCategoryColor = (cat) => {
                switch(cat) {
                    case '‡∏™‡∏õ‡∏™‡∏ä.': return 'bg-blue-100 text-blue-800 border-blue-200';
                    case '‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£': return 'bg-amber-100 text-amber-800 border-amber-200';
                    case '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°': return 'bg-purple-100 text-purple-800 border-purple-200';
                    default: return 'bg-gray-100 text-gray-800 border-gray-200';
                }
            };

            const getExpenseCategoryColor = (cat) => {
                switch(cat) {
                    case 'Labour cost ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á': return 'bg-rose-100 text-rose-800 border-rose-200';
                    case 'Material cost': return 'bg-orange-100 text-orange-800 border-orange-200';
                    case 'Capital cost': return 'bg-indigo-100 text-indigo-800 border-indigo-200';
                    default: return 'bg-gray-100 text-gray-800 border-gray-200';
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col gap-6 max-w-7xl mx-auto">
                    
                    {/* Header */}
                    <div className="flex items-center justify-between glass-panel p-6">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-3 rounded-lg text-white">
                                <Icons.TrendingUp />
                            </div>
                            <div>
                                <h1 className="text-xl md:text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h1>
                                <p className="text-gray-500 text-sm">Flow: ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (4 ‡πÇ‡∏´‡∏°‡∏î) ‚Üí ‡∏á‡∏ö‡∏£‡∏ß‡∏° ‚Üí ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (4 ‡πÇ‡∏´‡∏°‡∏î)</p>
                            </div>
                        </div>
                        <div className="text-right hidden md:block">
                            <div className="text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
                            <div className={`text-xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {balance >= 0 ? '‡∏Å‡∏≥‡πÑ‡∏£ (Surplus)' : '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (Deficit)'} {formatCurrency(Math.abs(balance))}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        
                        {/* Input Section (Left) - Kept Light for editing ease */}
                        <div className="xl:col-span-1 flex flex-col gap-6 h-full">
                            
                            {/* Incomes */}
                            <div className="glass-panel p-4 flex-1 flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <h2 className="text-lg font-semibold text-emerald-700">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Incomes)</h2>
                                        <div className="text-xs text-gray-500">‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏° 4 ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏´‡∏•‡∏±‡∏Å</div>
                                    </div>
                                    <button onClick={addIncome} className="text-emerald-600 bg-emerald-50 hover:bg-emerald-100 p-2 rounded transition">
                                        <Icons.Plus /> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                    </button>
                                </div>
                                <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1 max-h-[350px]">
                                    {incomes.map((item) => (
                                        <div key={item.id} className="bg-white p-3 rounded border border-gray-100 shadow-sm animate-fadeIn">
                                            <div className="flex gap-2 mb-2">
                                                <input 
                                                    type="text" 
                                                    value={item.name}
                                                    onChange={(e) => handleIncomeChange(item.id, 'name', e.target.value)}
                                                    className="flex-1 p-2 border border-gray-200 rounded text-sm focus:border-emerald-500"
                                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö"
                                                />
                                                <button onClick={() => removeIncome(item.id)} className="text-gray-400 hover:text-red-500 px-1">
                                                    <Icons.Trash />
                                                </button>
                                            </div>
                                            <div className="flex gap-2">
                                                <select 
                                                    value={item.category}
                                                    onChange={(e) => handleIncomeChange(item.id, 'category', e.target.value)}
                                                    className={`p-2 rounded text-xs border ${getIncomeCategoryColor(item.category)} font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none cursor-pointer appearance-none w-32`}
                                                >
                                                    {INCOME_CATEGORIES.map(cat => (
                                                        <option key={cat} value={cat}>{cat}</option>
                                                    ))}
                                                </select>
                                                <div className="relative flex-1">
                                                    <span className="absolute left-2 top-2 text-gray-400 text-sm">‡∏ø</span>
                                                    <input 
                                                        type="number" 
                                                        value={item.amount}
                                                        onChange={(e) => handleIncomeChange(item.id, 'amount', Number(e.target.value))}
                                                        className="w-full p-2 pl-6 border border-gray-200 rounded text-sm text-right focus:border-emerald-500 font-mono"
                                                        placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-3 border-t flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <span className="text-sm font-medium text-gray-600">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                                    <span className="text-lg font-bold text-emerald-600">{formatCurrency(totalIncome)}</span>
                                </div>
                            </div>

                            {/* Expenses */}
                            <div className="glass-panel p-4 flex-1 flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <h2 className="text-lg font-semibold text-red-700">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Expenses)</h2>
                                        <div className="text-xs text-gray-500">‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏° 4 ‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
                                    </div>
                                    <button onClick={addExpense} className="text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition">
                                        <Icons.Plus /> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                    </button>
                                </div>
                                <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1 max-h-[350px]">
                                    {expenses.map((item) => (
                                        <div key={item.id} className="bg-white p-3 rounded border border-gray-100 shadow-sm animate-fadeIn">
                                            <div className="flex gap-2 mb-2">
                                                <input 
                                                    type="text" 
                                                    value={item.name}
                                                    onChange={(e) => handleExpenseChange(item.id, 'name', e.target.value)}
                                                    className="flex-1 p-2 border border-gray-200 rounded text-sm focus:border-red-500"
                                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"
                                                />
                                                <button onClick={() => removeExpense(item.id)} className="text-gray-400 hover:text-red-500 px-1">
                                                    <Icons.Trash />
                                                </button>
                                            </div>
                                            <div className="flex gap-2">
                                                <select 
                                                    value={item.category}
                                                    onChange={(e) => handleExpenseChange(item.id, 'category', e.target.value)}
                                                    className={`p-2 rounded text-xs border ${getExpenseCategoryColor(item.category)} font-medium focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none cursor-pointer appearance-none w-36`}
                                                >
                                                    {EXPENSE_CATEGORIES.map(cat => (
                                                        <option key={cat} value={cat}>{cat}</option>
                                                    ))}
                                                </select>
                                                <div className="relative flex-1">
                                                    <span className="absolute left-2 top-2 text-gray-400 text-sm">‡∏ø</span>
                                                    <input 
                                                        type="number" 
                                                        value={item.amount}
                                                        onChange={(e) => handleExpenseChange(item.id, 'amount', Number(e.target.value))}
                                                        className="w-full p-2 pl-6 border border-gray-200 rounded text-sm text-right focus:border-red-500 font-mono"
                                                        placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-3 border-t flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <span className="text-sm font-medium text-gray-600">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                                    <span className="text-lg font-bold text-red-600">{formatCurrency(totalExpense)}</span>
                                </div>
                            </div>

                        </div>

                        {/* Chart Section (Dark Mode for White Text) */}
                        <div className="xl:col-span-2 dark-panel p-2 flex flex-col min-h-[700px]">
                           <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-lg">
                                <span className="text-lg text-white font-medium">Visualization: Financial Flows</span>
                                <div className="flex gap-3 text-xs flex-wrap">
                                     <span className="flex items-center gap-1 text-gray-300"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                                     <span className="flex items-center gap-1 text-gray-300"><span className="w-2 h-2 rounded-full bg-blue-600"></span> ‡∏á‡∏ö‡∏£‡∏ß‡∏°</span>
                                     <span className="flex items-center gap-1 text-gray-300"><span className="w-2 h-2 rounded-full bg-red-500"></span> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                                </div>
                           </div>
                           <div className="flex-1 w-full relative bg-gray-900 rounded-b-lg" ref={chartRef}>
                                {/* Plotly Chart renders here */}
                           </div>
                           <div className="p-3 bg-gray-800 text-gray-400 text-xs rounded-b-lg border-t border-gray-700 flex justify-between">
                                <span>üí° Dark Mode enabled for better readability on saved images.</span>
                                {balance < 0 && <span className="text-red-400 font-bold">‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≤‡∏î‡∏î‡∏∏‡∏• (Deficit)</span>}
                           </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
